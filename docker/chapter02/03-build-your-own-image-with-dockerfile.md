# 使用dockerfile创建镜像
> 2016-09-24 

[原文](https://docs.docker.com/engine/getstarted/step_four/#/build-your-own-image)

The whalesay image could be improved. It would be nice if you didn’t have to think of something to say. And you type a lot to get whalesay to talk.
```
docker run docker/whalesay cowsay boo-boo
```
在接下来的章节中，你将会改造` whalesay `镜像。并创建一个新版本，该版本会“自己说话”并且启动他只需要几个子而已。

## Step 01: 创建一个Dockerfile

这里，你可以使用自己最擅长的文本编辑器创建一个简短的Dockerfile。 Dockerfile中包含需要“烘培”进镜像的软件信息。虽然只是一些辅助信息，你可以指明软件需要的环境信息以及需要执行何种命令。这个Dockerfile会非常简单。

1. 打开命令行交互窗口

2. 通过命令` make mydockerbuild `创建一个新目录
```
$ mkdir mydockerbuild
```

3. 进入创建的目录
```
$ cd mydockerbuild
```
目前，该目录为空

4. 创建一个Dockerfile
```
$ touch Dockerfile
```
**注意：**实际使用中，Dockerfile的名称可以按照实际需求指定。

5. 使用你喜欢的编辑器编辑Dockerfile

6. 在Dockerfile中写入以下内容
```
FROM docker/whalesay:latest
```
` FROM `做为一个关键字，作用是告诉Docker使用哪个镜像作为基础镜像。这里我们使用的是whalesay。

7. 接着，给容器添加` fortunes `程序。
```
RUN apt-get -y update && apt-get install -y fortunes
```
` fortunes `程序的作用是让我们的鲸鱼说一些更加聪明的话。因此，第一步就是安装该程序。这一行的作用就是执行` apt-get `命令为镜像添加程序。

8. 当镜像安装了所需要的程序后，你就需要控制镜像在被加载的时候运行他们。
```
CMD /usr/games/fortunes -a | cowsay
```
这一行的的作用是使` fortunes `传递一些俏皮话给` cowsay `。

9. 检查你的Dockerfile，内容应该包含一下内容
```
FROM docker/whalesay:latest
RUN apt-get -y update && apt-get install -y fortunes
CMD /usr/games/fortune -a | cowsay
```

10. 保存Dockerfile
现在，在dockerfile中包含了所需的程序和所执行的动作。可以准备开始build一个全新的镜像了。

## Step 02: 通过Dockerfile创建镜像

1. 确认dockerfile的内容是否正确。
```
$ cat Dockerfile
FROM docker/whalesay:latest

RUN apt-get -y update && apt-get install -y fortunes

CMD /usr/games/fortune -a | cowsay
```

2. 使用命令` docker build -t docker-whale . `创建你的全新镜像。
> **注意：** 不要忘记在命令最后一个有一个 ` . (逗点句号)`

```
$ docker build -t docker-whale .
Sending build context to Docker daemon 158.8 MB
...snip...
Removing intermediate container a8e6faa88df3
Successfully built 7d9495d03763
```

docker build 命令参数
```
$ sudo docker build -h

Usage: docker build [OPTIONS] PATH | URL | -

Build a new image from the source code at PATH

  -c, --cpu-shares=0    CPU shares (relative weight)
  --cgroup-parent=      Optional parent cgroup for the container
  --cpu-period=0        Limit the CPU CFS (Completely Fair Scheduler) period
  --cpu-quota=0         Limit the CPU CFS (Completely Fair Scheduler) quota
  --cpuset-cpus=        CPUs in which to allow execution (0-3, 0,1)
  --cpuset-mems=        MEMs in which to allow execution (0-3, 0,1)
  -f, --file=           Name of the Dockerfile (Default is 'PATH/Dockerfile')
  --force-rm=false      Always remove intermediate containers
  --help=false          Print usage
  -m, --memory=         Memory limit
  --memory-swap=        Total memory (memory + swap), '-1' to disable swap
  --no-cache=false      Do not use cache when building the image
  --pull=false          Always attempt to pull a newer version of the image
  -q, --quiet=false     Suppress the verbose output generated by the containers
  --rm=true             Remove intermediate containers after a successful build
  -t, --tag=            Repository name (and optionally a tag) for the image
```

## Step 3: 了解build过程
命令` docker build -t docker-whale . ` 使用当前目录下的 ` Dockerfile `，创建了一个名为 ` docker-whale `的本地镜像。 创建命令执行了大约一分钟左右，日志输入看起来又长有复杂。在本节中，我们将为你解析这些日志。

**首先**， Docker需要确认创建镜像是所需要的一切。
```
Sending build context to Docker daemon 158.8 MB
```

**其次**， Docker加载` whalesay `镜像。 因为在之前已经将最新版本的whalesay下载到本地了，因此这里不需要再重新下载了。
```
Step 1 : FROM docker/whalesay:latest
 ---> fb434121fc77
```

**再次**， docker执行下一步操作，使用` apt-get `更新包管理器。这里显示了很多行内容，没必要全部列出来。
```
Step 2 : RUN apt-get -y update && apt-get install -y fortunes
 ---> Running in 27d224dfa5b2
Ign http://archive.ubuntu.com trusty InRelease
Ign http://archive.ubuntu.com trusty-updates InRelease
Ign http://archive.ubuntu.com trusty-security InRelease
Hit http://archive.ubuntu.com trusty Release.gpg
....snip...
Get:15 http://archive.ubuntu.com trusty-security/restricted amd64 Packages [14.8 kB]
Get:16 http://archive.ubuntu.com trusty-security/universe amd64 Packages [134 kB]
Reading package lists...
---> eb06e47a01d2
```

**再次**， docker开始安装 ` fortune `软件。
```
Removing intermediate container e2a84b5f390f
Step 3 : RUN apt-get install -y fortunes
 ---> Running in 23aa52c1897c
Reading package lists...
Building dependency tree...
Reading state information...
The following extra packages will be installed:
  fortune-mod fortunes-min librecode0
Suggested packages:
  x11-utils bsdmainutils
The following NEW packages will be installed:
  fortune-mod fortunes fortunes-min librecode0
0 upgraded, 4 newly installed, 0 to remove and 3 not upgraded.
Need to get 1961 kB of archives.
After this operation, 4817 kB of additional disk space will be used.
Get:1 http://archive.ubuntu.com/ubuntu/ trusty/main librecode0 amd64 3.6-21 [771 kB]
...snip......
Setting up fortunes (1:1.99.1-7) ...
Processing triggers for libc-bin (2.19-0ubuntu6.6) ...
 ---> c81071adeeb5
Removing intermediate container 23aa52c1897c
```

**最后**， 完成安装并报告结果
```
Step 4 : CMD /usr/games/fortune -a | cowsay
 ---> Running in a8e6faa88df3
 ---> 7d9495d03763
Removing intermediate container a8e6faa88df3
Successfully built 7d9495d03763
```

## Step 04: 启动你的docker-whale镜像

本节中，你将在本机确认你所创建的镜像，并启动他。

1. 打开命令行交互窗口
2. 使用命令 ` docker images` 查看镜像列表
```bash
$ docker images
REPOSITORY           TAG          IMAGE ID          CREATED             SIZE
docker-whale         latest       7d9495d03763      4 minutes ago       273.7 MB
docker/whalesay      latest       fb434121fc77      4 hours ago         247 MB
hello-world          latest       91c95931e552      5 weeks ago         910 B
```

3. 使用命令 ` docker run docker-whale ` 启动你的镜像
```bash
$ docker run docker-whale
 _________________________________________
/ "He was a modest, good-humored boy. It  \
\ was Oxford that made him insufferable." /
 -----------------------------------------
          \
           \
            \     
                          ##        .            
                    ## ## ##       ==            
                 ## ## ## ##      ===            
             /""""""""""""""""___/ ===        
        ~~~ {~~ ~~~~ ~~~ ~~~~ ~~ ~ /  ===- ~~~   
             \______ o          __/            
              \    \        __/             
                \____\______/   
```

正如你所见到的，你创建的鲸鱼更聪明。不仅自己会说话，而且命令更简单！你可能已经知道了，docker并没有下载任何东西，主要是因为本地已经包含了该镜像且能正常使用。

